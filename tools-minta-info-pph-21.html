<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Tools Pesan WA per Cab Induk</title>
<script src="xlsx.full.min.js"></script>

<style>
  body{font-family:Arial;background:#f5f6f8;margin:0}
  .container{max-width:1000px;margin:40px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
  .header-bar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .controls{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:14px}
  input[type=file]{padding:10px;border:1px solid #ddd;border-radius:10px;width:320px;background:#fff}
  button{padding:8px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:600}
  .btn{background:#111827;color:#fff}
  .btn:hover{opacity:.92}
  .btn-ghost{background:#e5e7eb;color:#111}
  .btn-ghost:hover{opacity:.92}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .muted{color:#6b7280;font-size:12px}
  .template{
    width:100%;height:170px;padding:12px;border:1px solid #ddd;border-radius:10px;
    font-family:Arial;font-size:13px;line-height:1.5;resize:vertical;
  }

  .result{margin-top:20px;display:flex;flex-direction:column;gap:12px}
  .row{
    background:#fff;border:1px solid #e5e7eb;border-radius:12px;
    padding:12px 14px;display:flex;align-items:center;gap:16px;
    box-shadow:0 3px 8px rgba(0,0,0,.04);
  }
  .left{min-width:160px}
  .tag{background:#f3f4f6;padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
  .preview{flex:1;font-size:13px;color:#111;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .right{min-width:240px;text-align:right;font-size:13px;color:#111}
  .actions{margin-top:6px;display:flex;justify-content:flex-end;gap:8px}

  /* MODAL */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;padding:14px}
  .modal-box{
    background:#fff;
    width:min(900px, calc(100vw - 32px));
    max-height:calc(100vh - 32px);
    overflow:hidden;
    border-radius:12px;padding:16px;
    display:flex;flex-direction:column;gap:10px;
  }
  .modal-box h4{margin:0}
  textarea.editbox{
    width:100%;height:320px;padding:12px;font-family:Arial;
    font-size:13px;line-height:1.5;border:1px solid #ddd;border-radius:10px;resize:vertical;
  }
  .modal-actions{display:flex;justify-content:flex-end;gap:10px}

  .hp-list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
  .hp-item{display:flex;gap:10px;align-items:center}
  .hp-item .name{width:220px;flex:0 0 220px;font-weight:600}
  .hp-item input{flex:1;padding:10px;border:1px solid #ddd;border-radius:10px}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="header-bar">
      <div>
        <h3 style="margin:0">Tools Pesan WA per Cab Induk</h3>
        <div class="muted" style="margin-top:6px">
          Upload Excel → Proses → Kirim WA.
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn-ghost" onclick="openHpManager()">EDIT NO HP</button>
        <button class="btn-ghost" onclick="resetHp()">RESET NO HP</button>
      </div>
    </div>

    <div class="controls">
      <input type="file" id="file" />
      <button class="btn" onclick="processExcel()">PROSES</button>
    </div>

    <div style="margin-top:14px">
      <div class="muted" style="margin-bottom:6px">
        Edit pesan, jangan ganti yang di tanda kurung kurawal ({{CAB}} dan {{DETAIL}} jng dihapus ya 
        <b>{{CAB}}</b> = Cab Induk, <b>{{DETAIL}}</b> = detail outlet per baris
      </div>
      <textarea id="templatePesan" class="template">Assalamuallaikum wr.wb, Selamat Pagi Bapak/Ibu {{CAB}} 
Mohon izin mau meminta informasi terkait foto KTP, Invoice, Faktur Pajak dari outlet sebagai berikut:

{{DETAIL}}

Terima kasih bapak/ibu atas perhatiannya..</textarea>
      <div class="muted" style="margin-top:6px">
        HARAP DIPERHATIKAN FILE EXCEL HEADER NYA HARUS DIBARIS 1 jika tidak akan eror saat analisis, headernya : Cab Induk | Outlet | Document No. | Tgl. Faktur Pajak | Nilai PPh |
      </div>
    </div>
  </div>

  <div id="hasil" class="result"></div>
</div>

<!-- MODAL EDIT PESAN (per cab) -->
<div id="modalPesan" class="modal">
  <div class="modal-box">
    <h4>Edit Pesan</h4>
    <textarea id="editPesan" class="editbox"></textarea>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeModalPesan()">BATAL</button>
      <button class="btn" onclick="saveEditPesan()">SIMPAN</button>
    </div>
  </div>
</div>

<!-- MODAL HP MANAGER -->
<div id="modalHpMgr" class="modal">
  <div class="modal-box">
    <h4>Kelola Nomor HP Cab Induk</h4>
    <div class="muted">Format disarankan: 62xxxxxxxxxxx (tanpa +, tanpa spasi). ini cuma disimpan di localstorage tidak disebarluaskan.</div>
    <div id="hpList" class="hp-list"></div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="closeHpManager()">TUTUP</button>
      <button class="btn" onclick="saveHpManager()">SIMPAN</button>
    </div>
  </div>
</div>

<script>
/* ========= DEFAULT NO HP (contoh saja, kamu akan ganti) ========= */
const CAB_HP_DEFAULT = {
  "CP BANDARJAYA":"",
  "CP BATURAJA":"",
  "CP BENGKULU":"",
  "CP CURUP":"",
  "CP JAKABARING":"",
  "CP JAMBI":"",
  "CP KEDATON":"",
  "CP KENTEN":"",
  "CP KOTABUMI":"",
  "CP LAHAT":"",
  "CP LEMABANG":"",
  "CP LUBUK LINGGAU":"",
  "CP MAYANG MANGURAI":"",
  "CP METRO":"",
  "CP MUARA BUNGO":"",
  "CP MUARAENIM":"",
  "CP PALEMBANG":"",
  "CP PALLIMA":"",
  "CP PANGKAL PINANG":"",
  "CP PRABUMULIH":"",
  "CP SEKIP":"",
  "CP SIMPANG PULAI":"",
  "CP SIPIN":"",
  "CP TANJUNG KARANG PUSAT":"",
  "CP TANJUNG KARANG TIMUR":"",
  "CP TANJUNG PANDAN":"",
  "CP TELUK BETUNG":"",
  "CPS BATURAJA":"",
  "CPS JELUTUNG":"",
  "CPS RADIN INTAN":"",
  "CPS SIMPANG PATAL":"",
  "CPS BENGKULU":"",
  "KANWIL":"",
  "KONVEN-KANWIL":"",
  "SYARIAH-KONVEN":"",
  "CPS SIMPANG SEKIP":"",
};

/* ========= LOCALSTORAGE KEY ========= */
const LS_KEY_HP = "bea_lelang_hp_map_v1";

/* ========= STATE ========= */
let CAB_HP = {};     // default + local override
let HP_DATA = {};    // editable runtime
let PESAN_DATA = {}; // pesan per cab (editable)
let EDIT_CAB = "";

/* ========= LOAD HP MAP ========= */
function loadHpMap(){
  const saved = localStorage.getItem(LS_KEY_HP);
  let savedObj = {};
  try { savedObj = saved ? JSON.parse(saved) : {}; } catch(e){ savedObj = {}; }
  CAB_HP = { ...CAB_HP_DEFAULT, ...savedObj };
  HP_DATA = { ...CAB_HP };
}
loadHpMap();

/* ========= HELPERS ========= */
function formatRp(v){
  let s = (v===undefined || v===null) ? "0" : v.toString();
  let n = parseFloat(s.replace(/\./g,"").replace(",","."));
  if(isNaN(n)) n=0;
  return "Rp " + n.toLocaleString("id-ID",{minimumFractionDigits:2, maximumFractionDigits:2});
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatTglExcel(v){
  if(v===undefined || v===null || v==="") return ""; // kosong tetap kosong

  // Kalau sudah string tanggal (mis "01/02/2026" atau "2026-02-01"), balikin apa adanya (rapihin sedikit)
  if(typeof v === "string"){
    const s = v.trim();
    if(!s) return "";

    // kalau format dd/mm/yyyy atau d/m/yyyy
    const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if(m){
      const dd = pad2(m[1]);
      const mm = pad2(m[2]);
      let yy = m[3];
      if(yy.length===2) yy = "20"+yy;
      return `${dd}/${mm}/${yy}`;
    }
    return s; // biarin kalau format lain
  }

  // Kalau Date object
  if(v instanceof Date && !isNaN(v)){
    return `${pad2(v.getDate())}/${pad2(v.getMonth()+1)}/${v.getFullYear()}`;
  }

  // Kalau angka serial Excel (46033, dll)
  if(typeof v === "number"){
    // 25569 = 1970-01-01 dalam serial excel (1900-date system)
    const utc_days = Math.floor(v - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);

    // handle pecahan hari (jam) kalau ada
    if(!isNaN(date_info)){
      return `${pad2(date_info.getUTCDate())}/${pad2(date_info.getUTCMonth()+1)}/${date_info.getUTCFullYear()}`;
    }
  }

  // fallback
  return (v || "").toString().trim();
}
function escapeId(s){ return s.replace(/[^a-zA-Z0-9_-]/g,"_"); }
function escapeAttr(s){ return s.replace(/'/g,"\\'"); }

/* ========= BUILD DETAIL FROM FILE PPH (header baris 1) ========= */
function processExcel(){
  const f = document.getElementById("file").files[0];
  if(!f) return alert("Upload file dulu");

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, {type:"binary"});
    const ws = wb.Sheets[wb.SheetNames[0]];

    // header baris 1 (tidak ada judul)
    const rows = XLSX.utils.sheet_to_json(ws, {
      defval:"",
      raw:true,        // biar angka tetap angka (kita format sendiri)
      cellDates:true   // kalau bisa, tanggal jadi Date object
    });

    let group = {};
    rows.forEach(r=>{
      const cab = (r["Cab Induk"] || "").toString().trim();
      const outlet = (r["Outlet"] || "").toString().trim();
      const doc = (r["Document No."] || "").toString().trim();
      const tgl = formatTglExcel(r["Tgl. Faktur Pajak"]);
      const pph = formatRp(r["Nilai PPh"]);

      if(!cab) return;
      if(!group[cab]) group[cab]=[];

      // detail per baris (boleh kamu ubah)
      group[cab].push(`- ${outlet} | Dokumen No: ${doc} | Tgl: ${tgl} | Nilai PPh *${pph}*`);
    });

    render(group);
  };
  reader.readAsBinaryString(f);
}

/* ========= TEMPLATE -> PESAN ========= */
function buildMessageFromTemplate(cab, detail){
  const tplEl = document.getElementById("templatePesan");
  const tpl = (tplEl && tplEl.value) ? tplEl.value : "{{CAB}}\n\n{{DETAIL}}";
  return tpl.split("{{CAB}}").join(cab).split("{{DETAIL}}").join(detail);
}

function getWAUrl(cab){
  const hp = (HP_DATA[cab] ?? CAB_HP[cab] ?? "");
  const msg = PESAN_DATA[cab] || "";
  return `https://wa.me/${hp}?text=${encodeURIComponent(msg)}`;
}

/* ========= RENDER LIST ========= */
function render(group){
  const div = document.getElementById("hasil");
  div.innerHTML = "";
  PESAN_DATA = {};

  Object.keys(group).sort().forEach(cab=>{
    const detail = group[cab].join("\n");
    const pesan = buildMessageFromTemplate(cab, detail);
    PESAN_DATA[cab] = pesan;

    const hp = (HP_DATA[cab] ?? CAB_HP[cab] ?? "");
    HP_DATA[cab] = hp;

    const wa = getWAUrl(cab);
    const disabled = !hp;

    // preview ringkas: ambil 1 baris pertama dari template yang sudah jadi
    const firstLine = (pesan.split("\n").find(x=>x.trim()) || "").trim();
    const preview = firstLine ? (firstLine + " …") : (cab + " …");

    div.innerHTML += `
      <div class="row">
        <div class="left"><span class="tag">${cab}</span></div>
        <div class="preview" title="Klik EDIT PESAN untuk lihat lengkap">${preview}</div>
        <div class="right">
          <div><b>No HP</b><br><span id="hp_${escapeId(cab)}">${hp}</span></div>
          <div class="actions">
            <button class="btn-ghost" onclick="openEditPesan('${escapeAttr(cab)}')">EDIT PESAN</button>
            <a id="wa_${escapeId(cab)}" href="${disabled ? '#' : wa}" target="_blank">
              <button class="btn" ${disabled ? 'disabled' : ''}>KIRIM</button>
            </a>
          </div>
        </div>
      </div>
    `;
  });
}

/* ========= EDIT PESAN (per cab) ========= */
function openEditPesan(cab){
  EDIT_CAB = cab;
  document.getElementById("editPesan").value = PESAN_DATA[cab] || "";
  document.getElementById("modalPesan").style.display = "flex";
}
function closeModalPesan(){
  document.getElementById("modalPesan").style.display = "none";
}
function saveEditPesan(){
  PESAN_DATA[EDIT_CAB] = document.getElementById("editPesan").value;

  const a = document.getElementById("wa_" + escapeId(EDIT_CAB));
  if(a) a.href = getWAUrl(EDIT_CAB);

  closeModalPesan();
  alert("Pesan diperbarui.");
}

/* ========= HP MANAGER (localStorage) ========= */
function openHpManager(){
  loadHpMap();

  const modal = document.getElementById("modalHpMgr");
  const list = document.getElementById("hpList");
  list.innerHTML = "";

  const cabs = new Set([...Object.keys(CAB_HP_DEFAULT), ...Object.keys(CAB_HP), ...Object.keys(HP_DATA), ...Object.keys(PESAN_DATA)]);
  Array.from(cabs).sort().forEach(cab=>{
    const val = (HP_DATA[cab] ?? CAB_HP[cab] ?? "");
    list.innerHTML += `
      <div class="hp-item">
        <div class="name">${cab}</div>
        <input id="hp_in_${escapeId(cab)}" value="${val}" placeholder="62xxxxxxxxxxx">
      </div>
    `;
  });

  modal.style.display = "flex";
}
function closeHpManager(){
  document.getElementById("modalHpMgr").style.display = "none";
}
function saveHpManager(){
  const cabs = new Set([...Object.keys(CAB_HP_DEFAULT), ...Object.keys(CAB_HP), ...Object.keys(HP_DATA), ...Object.keys(PESAN_DATA)]);
  let savedObj = {};

  Array.from(cabs).forEach(cab=>{
    const el = document.getElementById("hp_in_" + escapeId(cab));
    if(!el) return;

    let hp = (el.value || "").trim().replace(/[^\d]/g,"");
    if(hp) savedObj[cab] = hp;

    HP_DATA[cab] = hp;
    CAB_HP[cab] = hp;

    const hpEl = document.getElementById("hp_" + escapeId(cab));
    if(hpEl) hpEl.textContent = hp;

    const a = document.getElementById("wa_" + escapeId(cab));
    if(a){
      const disabled = !hp;
      a.href = disabled ? "#" : getWAUrl(cab);
      const btn = a.querySelector("button");
      if(btn) btn.disabled = disabled;
    }
  });

  localStorage.setItem(LS_KEY_HP, JSON.stringify(savedObj));
  closeHpManager();
  alert("Nomor HP berhasil di edit.");
}

function resetHp(){
  if(!confirm("Reset semua nomor HP (hapus localStorage)?")) return;
  localStorage.removeItem(LS_KEY_HP);
  loadHpMap();
  alert("Reset selesai. (Nomor kembali ke default (kosong))");
}

/* ========= CLOSE MODAL ON BACKDROP ========= */
document.getElementById("modalPesan").addEventListener("click",(e)=>{
  if(e.target.id==="modalPesan") closeModalPesan();
});
document.getElementById("modalHpMgr").addEventListener("click",(e)=>{
  if(e.target.id==="modalHpMgr") closeHpManager();
});
</script>
</body>

</html>


